install.packages('caret')
install.packages('caTools')
install.packages('shiny')
install.packages('e1071')
install.packages('jsonlite')
install.packages('ggplot2')
install.packages('rsconnect')
library(caret)
library(e1071)
library(rpart.plot)
library(ggplot2)
library(shiny)
library(caTools)
getFilesFromWD <- function (wd) {
  setwd(wd)
  filesList <- list.files()
  return(filesList)
}
getMatchIDSfromJSON <- function( hero_id) {
  wd <-"C:\\data\\byHero"
  nFiles <- length(getFilesFromWD(paste(paste(wd,"\\00-",sep=""), hero_id, sep=""))) -1
  list <- list()
  temp <- list()
  library(jsonlite)
  setwd(paste(paste(wd,"\\00-",sep=""), hero_id, sep=""))
  for(j in 0:9) {
    tryCatch({
      paste("0",j, sep="")
      name <- paste(paste(paste(paste("0",j, sep="") ,"-", sep=""),hero_id,sep=""),".json", sep="")
      data <- fromJSON(name, flatten=TRUE)
      temp$match_id <- data$result$matches$match_id
      list <- rbind(list, as.data.frame(temp))
      
    },error = function(cond) {
      return (NA)
    }, warning = function(cond) {
      return (NULL)
    })
  }
 
  return (list)
}
getByIDSFromURI <- function(list, hero_id){
  # setwd("C:\\Users\\gabri\\git\\APIDotaMiner\\apiMinerDota\\files\\out\\byHero\\test\\00-4")
  
  library(jsonlite)
  link <- "https://api.opendota.com/api/matches/"
  temp <- list()
  retorno <- list()
  data <- list()
  for (i in 1:length(list$match_id)){
    
    tryCatch({
      data <- fromJSON(paste(link,list$match_id[i],sep=""), flatten=TRUE)
      temp = getVariables(data, hero_id)
      retorno <- rbind(retorno,temp)
    },error = function(cond) {
      return (NA)
    }, warning = function(cond) {
      return (NULL)
    })
  }
  setwd('C:\\data\\out')
  write.csv(retorno, file=paste(paste("teste_hero",hero_id, sep=""), ".csv", sep=""))
  return(retorno)
}
getVariables <- function(data, hero_id) {
  id <- NA
  for(i in 1:length(data$players$hero_id)) {
    if(data$players$hero_id[i]==hero_id) {
      id = i
    } 
    
  }
  if(!is.na(id)) {
    temp <- list()
    temp$match_id                                     <- data$match_id
    temp$game_mode                                    <- data$game_mode
    temp$dire_score                                   <- data$dire_score
    temp$human_players                                <- data$human_players
    temp$lobby_type                                   <- data$lobby_type
    temp$engine                                       <- data$engine
    temp$radiant_win                                  <- data$radiant_win
    temp$radiant_score                                <- data$radiant_score
    temp$player.player_slot                           <- data$players$player_slot[id]
    temp$player.assists                               <- data$players$assists[id]
    temp$player.deaths                                <- data$players$deaths[id]
    temp$player.denies                                <- data$players$denies[id]
    temp$player.hero_damage                           <- data$players$hero_damage[id]
    temp$player.hero_healing                          <- data$players$hero_healing[id]
    temp$player.hero_id                               <- data$players$hero_id[id]
    temp$player.item_0                                <- data$players$item_0[id]
    temp$player.item_1                                <- data$players$item_1[id]
    temp$player.item_2                                <- data$players$item_2[id]
    temp$player.item_3                                <- data$players$item_3[id]
    temp$player.item_4                                <- data$players$item_4[id]
    temp$player.item_5                                <- data$players$item_5[id]
    temp$player.kills                                 <- data$players$kills[id]
    temp$player.leaver_status                         <- data$players$leaver_status[id]
    temp$player.level                                 <- data$players$level[id]
    temp$player.tower_damage                          <- data$players$tower_damage[id]
    temp$player.isRadiant                             <- data$players$isRadiant[id]
    temp$player.win                                   <- data$players$win[id]
    temp$player.lose                                  <- data$players$lose[id]
    temp$player.kda                                   <- data$players$kda[id]
    temp$player.abandons                              <- data$players$abandons[id]
    temp$player.benchmarks.gold_per_min.raw 			    <-data$players$benchmarks.gold_per_min.raw[id]
    temp$player.benchmarks.gold_per_min.pct 			    <-data$players$benchmarks.gold_per_min.pct[id]
    temp$player.benchmarks.hero_damage_per_min.raw 	  <-data$players$benchmarks.hero_damage_per_min.raw[id]
    temp$player.benchmarks.hero_damage_per_min.pct 	  <-data$players$benchmarks.hero_damage_per_min.pct[id]
    temp$player.benchmarks.hero_healing_per_min.raw   <-data$players$benchmarks.hero_healing_per_min.raw[id]
    temp$player.benchmarks.hero_healing_per_min.pct	  <-data$players$benchmarks.hero_healing_per_min.pct[id]
    temp$player.benchmarks.tower_damage.raw			      <-data$players$benchmarks.tower_damage.raw[id]
    temp$player.benchmarks.tower_damage.pct			      <-data$players$benchmarks.tower_damage.pct[id]
    temp$player.benchmarks.xp_per_min.raw 				    <-data$players$benchmarks.xp_per_min.raw [id]
    temp$player.benchmarks.xp_per_min.pct  			      <-data$players$benchmarks.xp_per_min.pct  [id]
    temp$player.benchmarks.kills_per_min.raw 			    <-data$players$benchmarks.kills_per_min.raw [id]
    temp$player.benchmarks.kills_per_min.pct			    <-data$players$benchmarks.kills_per_min.pct[id]
    temp$player.benchmarks.hits_per_min.raw  			    <-data$players$benchmarks.hits_per_min.raw [id] 
    temp$player.benchmarks.hits_per_min.pct 			    <-data$players$benchmarks.hits_per_min.pct [id]
  }
  return(temp)
}
getTree <- function(hero_id) {
  setwd('C:\\data\\out')
  data <- read.csv(paste(paste( 'teste_hero',hero_id, sep=""), '.csv', sep=""))
  data$player.item_0 <- as.factor(data$player.item_0)
  data$player.item_1 <- as.factor(data$player.item_1)
  data$player.item_2 <- as.factor(data$player.item_2)
  data$player.item_3 <- as.factor(data$player.item_3)
  data$player.item_4 <- as.factor(data$player.item_4)
  data$player.item_5 <- as.factor(data$player.item_5)
  #install.packages('caret')
  library(caret)
  #install.packages('rpart')
  library(rpart)
  library(rpart.plot)
  #install.packages('ggplot2')
  library(ggplot2)
  #install.packages('caTools')
  library(caTools)
  
  spl <- sample.split(data$player.win, SplitRatio = 0.7)
  Train <- subset(data, spl==TRUE)
  Test <- subset(data, spl==FALSE)
  res1 <- rpart(player.win~player.item_0+player.item_1+player.item_2+player.item_3+player.item_4+player.item_5, 
                data=Train, 
                method="class", 
                minbucket=15)
  predict <- predict(res1, newdata = Test, type="class")
  table(Test$player.win, predict)
  #pdf('pdfs\\treeCV.pdf') 
  prp(res1)
  #dev.off()
}
getTreeCV <- function(hero_id) {
  setwd('C:\\data\\out')
  data <- read.csv(paste(paste( 'teste_hero',hero_id, sep=""), '.csv', sep=""))
  data$player.win <- as.factor(data$player.win)
  data$player.item_0 <- as.factor(data$player.item_0)
  data$player.item_1 <- as.factor(data$player.item_1)
  data$player.item_2 <- as.factor(data$player.item_2)
  data$player.item_3 <- as.factor(data$player.item_3)
  data$player.item_4 <- as.factor(data$player.item_4)
  data$player.item_5 <- as.factor(data$player.item_5)
  
  spl <- sample.split(data$player.win, SplitRatio = 0.7)
  Train <- subset(data, spl==TRUE)
  Test <- subset(data, spl==FALSE)
  #numfolds <- trainControl(method = "cv", number=6)
  #cpgrid = expand.grid(.cp=seq(0.001,0.1,0.001))
  #train <- train(player.win~player.item_0+player.item_1+player.item_2+player.item_3+player.item_4+player.item_5, 
  #               data=Train,
  #               method="rpart",
  #               trControl=numfolds,
  #               tuneGrid=cpgrid)
  treecv <-  rpart(player.win~player.item_0+player.item_1+player.item_2+player.item_3+player.item_4+player.item_5, 
                   data=data,
                   method="class",
                   cp=0.004)
  predictcv <- predict(treecv, newdata=data, type="class")
  table(data$player.win, predictcv)
  #pdf('pdfs\\treeCV.pdf') 
  prp(treecv)
  #dev.off() 
}
getTreeFromInput <- function(input) {
  setwd('C:\\data\\out')
  data <- read.csv(paste(paste( 'teste_hero',hero_id, sep=""), '.csv', sep=""))
  data$player.win <- as.factor(data$player.win)
  data$player.item_0 <- as.factor(data$player.item_0)
  data$player.item_1 <- as.factor(data$player.item_1)
  data$player.item_2 <- as.factor(data$player.item_2)
  data$player.item_3 <- as.factor(data$player.item_3)
  data$player.item_4 <- as.factor(data$player.item_4)
  data$player.item_5 <- as.factor(data$player.item_5)
  
  treecv <-  rpart(player.win~player.item_0+player.item_1+player.item_2+player.item_3+player.item_4+player.item_5, 
                   data=data,
                   method="class",
                   cp=0.003)
  
  teste = list()
  teste$player.item_0 <- as.factor(input$item_0)
  teste$player.item_1 <- as.factor(input$item_1)
  teste$player.item_2 <- as.factor(input$item_2)
  teste$player.item_3 <- as.factor(input$item_3)
  teste$player.item_4 <- as.factor(input$item_4)
  teste$player.item_5 <- as.factor(input$item_5)
  
  
  
  return(predict(treecv, newdata = teste, type = "class"))
}
getNeural <- function (hero_id) {
  library(neuralnet)
  setwd('C:\\data\\out')
  Train <- read.csv(paste(paste( 'teste_hero',hero_id, sep=""), '.csv', sep=""))
  normalizedTrain = list()
  normalizedTrain <- as.data.frame(normalize(Train))
  net <- neuralnet(player.win ~ player.assists + 
                     player.denies + 
                     player.deaths + 
                     player.kills + 
                     player.level + 
                     player.benchmarks.gold_per_min.raw + 
                     player.tower_damage + 
                     player.hero_damage,
                   data = normalizedTrain,
                   hidden = 2,
                   threshold = 0.01,
                   linear.output = FALSE,
                   act.fct = 'logistic',
                   err.fct = 'sse')
  net.pred <- compute(net, normalizedTrain[,
                                           c("player.assists",
                                             "player.denies",
                                             "player.deaths",
                                             "player.kills",
                                             "player.level", 
                                             "player.benchmarks.gold_per_min.raw",
                                             "player.tower_damage",
                                             "player.hero_damage")])
  results <- data.frame(actual <- normalizedTrain$player.win, predict <- net.pred$net.result)
  #results
  roundedResults <- sapply(results, round, digits=0)
  roundedResults <- as.data.frame(roundedResults)
  #table(roundedResults)
  mse <- sum((normalizedTrain$player.win - net.pred$net.result)^2/nrow(normalizedTrain))
  plot(net)
  
}
normalize <- function (Train) {
  data <- Train
  t<- list()
  normalized <- list()
  t$player.win <- data$player.win
  t$player.assists <- data$player.assists
  t$player.denies <- data$player.denies
  t$player.deaths <- data$player.deaths
  t$player.kills <- data$player.kills
  t$player.level <- data$player.level
  t$player.hero_healing <- data$player.hero_healing
  t$player.benchmarks.gold_per_min.raw  <- data$player.benchmarks.gold_per_min.raw
  t$player.tower_damage <- data$player.tower_damage
  t$player.hero_damage <- data$player.hero_damage
  ranges <- list()
  ranges <- sapply(t, function(x) {return ((x - min(x)) / (max(x) - min (x)) )})
  normalized <- sapply(t, function(x) {return ((x - min(x)) / (max(x) - min (x)) )})
  # setwd('C:\\data\\out')
  # write.csv(normalized, file=paste(paste("normalizedTrain_hero",hero_id, sep=""), ".csv", sep=""))
  # write.csv(ranges, file=paste(paste("ranges_hero",hero_id, sep=""), ".csv", sep=""))
  return(normalized)
}
# Define UI for data download app ----
ui <- fluidPage(sidebarLayout(
  sidebarPanel(
# a select input
    selectInput('hero_id', 'hero_id', choices = list(
      hero_id = c(`Anti-Mage` = '1',
                  `Axe` = '2', 
                  `Bane` = '3', 
                  `Bloodseeker` = '4',
                  `Drow Ranger` = '6',
                  `Lina` = '25',
                  `Silencer` = '75',
                  `Lich` = '31',
                  `Phoenix` = '110',
                  `Shadow Shaman` = '27',
                  `Lifestealer` = '54',
                  `Sven` = '18',
                  `Huskar` = '59',
                  `Pudge` = '14',
                  `Wraith King` = '42'
      )), selectize = FALSE),
#item_0
    selectInput('item_0','item_0', choices = list (
      item_0 = c(									
        `power_treads` = '63',
        `tango` = '44',
        `poor_mans_shield` = '71',
        `quelling_blade` = '11',
        `faerie_fire` = '237',
        `phase_boots` = '50', 
        `iron_talon` = '239', 
        `talisman_of_evasion` = '32', 
        `stout_shield` = '182', 
        `tpscroll` = '46', 
        `vitality_booster` = '61', 
        `blade_mail` = '127', 
        `sange_and_yasha` = '154', 
        `ring_of_regen` = '27', 
        `boots` = '29', 
        `tranquil_boots` = '214', 
        `dagon` = '104', 
        `infused_raindrop` = '265', 
        `black_king_bar` = '116', 
        `dagon_5` = '204', 
        `radiance` = '137', 
        `invis_sword` = '152',    
        `hand_of_midas` = '65', 
        `ring_of_aquila` = '212', 
        `cyclone` = '100', 
        `gem` = '30',  
        `boots_of_elves` = '18', 
        `ancient_janggo` = '185', 
        `wind_lace` = '244', 
        `magic_stick` = '34', 
        `desolator` = '168', 
        `magic_wand` = '36',  
        `travel_boots` = '48', 
        `ward_observer` = '42', 
        `bloodthorn` = '250', 
        `force_staff` = '102', 
        `mithril_hammer` = '8', 
        `soul_booster` = '129', 
        `null_talisman` = '77', 
        `blight_stone` = '240', 
        `branches` = '16', 
        `echo_sabre` = '252', 
        `arcane_boots` = '180', 
        `mjollnir` = '158', 
        `butterfly` = '139', 
        `ultimate_scepter` = '108', 
        `shadow_amulet` = '215',  
        `ogre_axe` = '21', 
        `wraith_band` = '75', 
        `armlet` = '151',  
        `gloves` = '25', 
        `vladmir` = '81', 
        `maelstrom` = '166',   
        `ring_of_basilius` = '88', 
        `hyperstone` = '55', 
        `clarity` = '38', 
        `vanguard` = '125', 
        `necronomicon_3` = '194',  
        `manta` = '147', 
        `dust` = '40', 
        `lesser_crit` = '149', 
        `solar_crest` = '229', 
        `quarterstaff` = '10', 
        `yasha` = '170', 
        `orb_of_venom` = '181', 
        `chainmail` = '4', 
        `dagon_2` = '201', 
        `dagon_4` = '203', 
        `basher` = '143', 
        `silver_edge` = '249', 
        `ghost` = '37', 
        `greater_crit` = '141', 
        `rapier` = '133',  
        `point_booster` = '60', 
        `tango_single` = '241', 
        `soul_ring` = '178', 
        `assault` = '112', 
        `mask_of_madness` = '172', 
        `sange` = '162',    
        `blink` = '1', 
        `flask` = '39', 
        `moon_shard` = '247',   
        `broadsword` = '3', 
        `octarine_core` = '235', 
        `orchid` = '98',  
        `staff_of_wizardry` = '23', 
        `abyssal_blade` = '208',   
        `blades_of_attack` = '2', 
        `ring_of_health` = '56', 
        `bottle` = '41', 
        `monkey_king_bar` = '135', 
        `demon_edge` = '51', 
        `slippers` = '14', 
        `headdress` = '94', 
        `bfury` = '145', 
        `aegis` = '117', 
        `aeether_lens` = '232', 
        `relic` = '54', 
        `diffusal_blade` = '174', 
        `dagon_3` = '202', 
        `blade_of_alacrity` = '22', 
        `heavens_halberd` = '210', 
        `recipe_sange` = '161', 
        `shivas_guard` = '119', 
        `heart` = '114', 
        `belt_of_strength` = '17', 
        `javelin` = '7', 
        `recipe_yasha` = '169', 
        `urn_of_shadows` = '92',  
        `robe` = '19', 
        `sphere` = '123', 
        `smoke_of_deceit` = '188', 
        `enchanted_mango` = '216', 
        `void_stone` = '57', 
        `ward_sentry` = '43'
      )), selectize = FALSE),   
    
    
    selectInput('item_1','item_1', choices = list (
      item_1 = c(	
        `poor_mans_shield` = '71',
        `empty` = '0',
        `power_treads` = '63',
        `quelling_blade` = '11',
        `magic_wand` = '36', 
        `circlet` = '20', 
        `stout_shield` = '182', 
        `ring_of_protection` = '12', 
        `blade_mail` = '127', 
        `ring_of_aquila` = '212', 
        `branches` = '16', 
        `phase_boots` = '50', 
        `tango` = '44',
        `shadow_amulet` = '215', 
        `iron_talon` = '239', 
        `tpscroll` = '46', 
        `dust` = '40', 
        `wraith_band` = '75', 
        `radiance` = '137', 
        `ring_of_regen` = '27', 
        `sange_and_yasha` = '154', 
        `invis_sword` = '152', 
        `yasha` = '170', 
        `smoke_of_deceit` = '188', 
        `wind_lace` = '244', 
        `tango_single` = '241', 
        `sobi_mask` = '28', 
        `belt_of_strength` = '17', 
        `force_staff` = '102', 
        `dagon_2` = '201', 
        `monkey_king_bar` = '135', 
        `sphere` = '123', 
        `mekansm` = '79', 
        `desolator` = '168', 
        `faerie_fire` = '237',
        `ring_of_health` = '56', 
        `recipe_yasha` = '169', 
        `flask` = '39', 
        `clarity` = '38', 
        `magic_stick` = '34', 
        `blades_of_attack` = '2', 
        `mask_of_madness` = '172', 
        `basher` = '143', 
        `robe` = '19', 
        `hand_of_midas` = '65', 
        `cloak` = '31', 
        `boots` = '29', 
        `enchanted_mango` = '216', 
        `oblivion_staff` = '67', 
        `recipe_radiance` = '136', 
        `blight_stone` = '240', 
        `travel_boots_2` = '220', 
        `manta` = '147', 
        `aegis` = '117', 
        `abyssal_blade` = '208', 
        `cyclone` = '100', 
        `heavens_halberd` = '210', 
        `ghost` = '37', 
        `maelstrom` = '166', 
        `travel_boots` = '48', 
        `infused_raindrop` = '265', 
        `dagon_5` = '204', 
        `gloves` = '25', 
        `quarterstaff` = '10', 
        `echo_sabre` = '252', 
        `black_king_bar` = '116', 
        `diffusal_blade` = '174', 
        `vladmir` = '81', 
        `slippers` = '14', 
        `hyperstone` = '55', 
        `orb_of_venom` = '181', 
        `vanguard` = '125', 
        `skadi` = '160', 
        `sange` = '162', 
        `boots_of_elves` = '18', 
        `ancient_janggo` = '185', 
        `octarine_core` = '235', 
        `butterfly` = '139', 
        `broadsword` = '3', 
        `armlet` = '151', 
        `soul_booster` = '129', 
        `heart` = '114', 
        `assault` = '112', 
        `ogre_axe` = '21', 
        `blade_of_alacrity` = '22', 
        `bracer` = '73', 
        `arcane_boots` = '180', 
        `mjollnir` = '158', 
        `dagon_3` = '202', 
        `null_talisman` = '77', 
        `soul_ring` = '178', 
        `mithril_hammer` = '8', 
        `greater_crit` = '141', 
        `silver_edge` = '249', 
        `javelin` = '7', 
        `gauntlets` = '13', 
        `lesser_crit` = '149', 
        `bfury` = '145', 
        `ultimate_scepter` = '108', 
        `point_booster` = '60', 
        `gem` = '30', 
        `bloodthorn` = '250', 
        `rapier` = '133', 
        `platemail` = '9', 
        `void_stone` = '57', 
        `shivas_guard` = '119', 
        `chainmail` = '4', 
        `pers` = '69', 
        `relic` = '54', 
        `ring_of_basilius` = '88', 
        `demon_edge` = '51', 
        `staff_of_wizardry` = '23', 
        `dagon_4` = '203', 
        `mystic_staff` = '58', 
        `tranquil_boots` = '214', 
        `orchid` = '98', 
        `blink` = '1', 
        `pipe` = '90', 
        `hood_of_defiance` = '131', 
        `refresher` = '110', 
        `ward_observer` = '42', 
        `bloodstone` = '121', 
        `ultimate_orb` = '24', 
        `cheese` = '33'
      )), selectize = FALSE), 
    
    selectInput('item_2','item_2', choices = list (
      item_2 = c(	
        `ring_of_aquila` = '212', 
        `empty` = '0',
        `magic_stick` = '34', 
        `stout_shield` = '182', 
        `iron_talon` = '239', 
        `quelling_blade` = '11',
        `power_treads` = '63',
        `blight_stone` = '240', 
        `branches` = '16', 
        `phase_boots` = '50', 
        `blade_mail` = '127', 
        `sange_and_yasha` = '154', 
        `boots` = '29', 
        `tpscroll` = '46', 
        `lesser_crit` = '149', 
        `blade_of_alacrity` = '22', 
        `echo_sabre` = '252', 
        `yasha` = '170', 
        `hand_of_midas` = '65', 
        `invis_sword` = '152', 
        `ring_of_regen` = '27', 
        `poor_mans_shield` = '71',
        `blink` = '1', 
        `urn_of_shadows` = '92', 
        `orchid` = '98', 
        `magic_wand` = '36', 
        `ultimate_scepter` = '108', 
        `radiance` = '137', 
        `tango` = '44',
        `ring_of_basilius` = '88', 
        `enchanted_mango` = '216', 
        `blades_of_attack` = '2', 
        `travel_boots` = '48', 
        `talisman_of_evasion` = '32', 
        `dust` = '40', 
        `oblivion_staff` = '67', 
        `desolator` = '168', 
        `cyclone` = '100', 
        `diffusal_blade` = '174', 
        `monkey_king_bar` ='135', 
        `black_king_bar` = '116', 
        `silver_edge` = '249', 
        `ogre_axe` = '21', 
        `basher` = '143', 
        `manta` = '147', 
        `flask` = '39', 
        `faerie_fire` = '237',
        `force_staff` = '102', 
        `gauntlets` = '13', 
        `soul_ring` = '178', 
        `mithril_hammer` = '8', 
        `ring_of_health` = '56', 
        `dagon_3` = '202', 
        `maelstrom` = '166', 
        `belt_of_strength` = '17', 
        `tranquil_boots` = '214', 
        `gloves` = '25', 
        `ring_of_protection` = '12', 
        `clarity` = '38', 
        `necronomicon` = '106', 
        `abyssal_blade` = '208', 
        `boots_of_elves` = '18', 
        `robe` = '19', 
        `chainmail` = '4', 
        `slippers` = '14', 
        `butterfly` = '139', 
        `mjollnir` = '158', 
        `demon_edge` = '51', 
        `wind_lace` = '244', 
        `heart` = '114', 
        `dagon_2` = '201', 
        `ward_observer` = '42', 
        `ancient_janggo` = '185', 
        `orb_of_venom` = '181', 
        `bracer` = '73', 
        `veil_of_discord` = '190', 
        `claymore` = '5', 
        `null_talisman` = '77', 
        `bfury` = '145', 
        `relic` = '54', 
        `bottle` = '41', 
        `arcane_boots` = '180', 
        `smoke_of_deceit` = '188', 
        `tango_single` = '241', 
        `infused_raindrop` = '265', 
        `headdress` = '94', 
        `armlet` = '151', 
        `mask_of_madness` = '172', 
        `staff_of_wizardry` = '23', 
        `satanic` = '156', 
        `ultimate_orb` = '24', 
        `assault` = '112', 
        `greater_crit` = '141', 
        `rod_of_atos` = '206', 
        `necronomicon_3` = '194', 
        `point_booster` = '60', 
        `broadsword` = '3', 
        `sange` = '162', 
        `dagon_5` = '204', 
        `dagon_4` = '203', 
        `aegis` = '117', 
        `hyperstone` = '55', 
        `circlet` = '20', 
        `lifesteal` = '26', 
        `solar_crest` = '229', 
        `sphere` = '123', 
        `diffusal_blade_2` = '196', 
        `void_stone` = '57', 
        `gem` = '30', 
        `dagon` = '104', 
        `soul_booster` = '129', 
        `wraith_band` = '75', 
        `travel_boots_2` = '220', 
        `recipe_radiance` = '136', 
        `pers` = '69', 
        `rapier` = '133', 
        `heavens_halberd` = '210'
      )), selectize = FALSE),
    
    selectInput('item_3','item_3', choices = list (
      item_3 = c(	
        `tpscroll` = '46', 
        `quelling_blade` = '11',
        `gloves` = '25', 
        `empty` = '0',
        `tango` = '44',
        `armlet` = '151', 
        `power_treads` = '63',
        `ultimate_scepter` = '108', 
        `branches` = '16', 
        `poor_mans_shield` = '71',
        `infused_raindrop` = '265', 
        `blade_mail` = '127', 
        `magic_wand` = '36', 
        `blight_stone` = '240', 
        `maelstrom` = '166', 
        `dust` = '40', 
        `boots_of_elves` = '18', 
        `hand_of_midas` = '65', 
        `orb_of_venom` = '181', 
        `invis_sword` = '152', 
        `ring_of_regen` = '27', 
        `faerie_fire` = '237',
        `mithril_hammer` = '8', 
        `stout_shield` = '182', 
        `lifesteal` = '26', 
        `travel_boots` = '48', 
        `belt_of_strength` = '17', 
        `urn_of_shadows` = '92', 
        `radiance` = '137', 
        `sange_and_yasha` = '154', 
        `basher` = '143', 
        `arcane_boots` = '180', 
        `iron_talon` = '239', 
        `yasha` = '170', 
        `reaver` = '53', 
        `phase_boots` = '50', 
        `echo_sabre` = '252', 
        `headdress` = '94', 
        `lesser_crit` = '149', 
        `cyclone` = '100', 
        `black_king_bar` = '116', 
        `ring_of_aquila` = '212', 
        `enchanted_mango` = '216', 
        `flask` = '39', 
        `slippers` = '14', 
        `boots` = '29', 
        `point_booster` = '60', 
        `ogre_axe` = '21', 
        `moon_shard` = '247', 
        `hyperstone` = '55', 
        `wind_lace` = '244', 
        `abyssal_blade` = '208', 
        `clarity` = '38', 
        `ghost` = '37', 
        `void_stone` = '57', 
        `ethereal_blade` = '176', 
        `desolator` = '168', 
        `talisman_of_evasion` = '32', 
        `force_staff` = '102', 
        `gem` = '30', 
        `vitality_booster` = '61', 
        `sange` = '162', 
        `tango_single` = '241', 
        `sphere` = '123', 
        `ring_of_protection` = '12', 
        `recipe_yasha` = '169', 
        `bracer` = '73', 
        `robe` = '19', 
        `blade_of_alacrity` = '22', 
        `heart` = '114', 
        `manta` = '147', 
        `aegis` = '117', 
        `dagon_2` = '201', 
        `wraith_band` = '75', 
        `relic` = '54', 
        `silver_edge` = '249', 
        `mask_of_madness` = '172', 
        `assault` = '112', 
        `ring_of_health` = '56', 
        `butterfly` = '139', 
        `shadow_amulet` = '215', 
        `recipe_dagon` = '103', 
        `staff_of_wizardry` = '23', 
        `mjollnir` = '158', 
        `blades_of_attack` = '2', 
        `javelin` = '7', 
        `magic_stick` = '34', 
        `eagle` = '52', 
        `circlet` = '20', 
        `dagon_4` = '203', 
        `rapier` = '133', 
        `broadsword` = '3', 
        `helm_of_iron_will` = '6', 
        `recipe_sange` = '161', 
        `tranquil_boots` = '214', 
        `glimmer_cape` = '254', 
        `skadi` = '160', 
        `gauntlets` = '13', 
        `monkey_king_bar` = '135', 
        `blink` = '1', 
        `dagon_5` = '204', 
        `diffusal_blade` = '174', 
        `pers` = '69', 
        `dagon` = '104', 
        `vladmir` = '81', 
        `ward_observer` = '42', 
        `dagon_3` = '202', 
        `oblivion_staff` = '67', 
        `null_talisman` = '77', 
        `quarterstaff` = '10', 
        `chainmail` = '4', 
        `bfury` = '145', 
        `heavens_halberd` = '210', 
        `travel_boots_2` = '220', 
        `greater_crit` = '141', 
        `smoke_of_deceit` = '188', 
        `recipe_radiance` = '136', 
        `ancient_janggo` = '185' 
      )), selectize = FALSE),
    
    selectInput('item_4','item_4', choices = list (
      item_4 = c(	
        `blade_mail` = '127', 
        `empty` = '0',
        `tpscroll` = '46', 
        `wraith_band` = '75', 
        `clarity` = '38', 
        `radiance` = '137', 
        `poor_mans_shield` = '71',
        `vitality_booster` = '61', 
        `branches` = '16', 
        `chainmail` = '4', 
        `stout_shield` = '182', 
        `infused_raindrop` = '265', 
        `orb_of_venom` = '181', 
        `power_treads` = '63',
        `travel_boots` = '48', 
        `ring_of_regen` = '27', 
        `yasha` = '170', 
        `sange_and_yasha` = '154', 
        `invis_sword` = '152', 
        `force_staff` = '102', 
        `tango_single` = '241', 
        `mithril_hammer` = '8', 
        `robe` = '19', 
        `pers` = '69', 
        `magic_wand` = '36', 
        `black_king_bar` = '116', 
        `ring_of_aquila` = '212', 
        `echo_sabre` = '252', 
        `quelling_blade` = '11',
        `maelstrom` = '166', 
        `blade_of_alacrity` = '22', 
        `lifesteal` = '26', 
        `oblivion_staff` = '67', 
        `ultimate_scepter` = '108', 
        `boots` = '29', 
        `blight_stone` = '240', 
        `phase_boots` = '50', 
        `talisman_of_evasion` = '32', 
        `basher` = '143', 
        `gem` = '30', 
        `cyclone` = '100', 
        `hand_of_midas` = '65', 
        `tango` = '44',
        `broadsword` = '3', 
        `dust` = '40', 
        `faerie_fire` = '237',
        `heart` = '114', 
        `reaver` = '53', 
        `helm_of_iron_will` = '6', 
        `enchanted_mango` = '216', 
        `void_stone` = '57', 
        `iron_talon` = '239', 
        `ring_of_health` = '56', 
        `ogre_axe` = '21', 
        `sphere` = '123', 
        `wind_lace` = '244', 
        `sange` = '162', 
        `relic` = '54', 
        `hyperstone` = '55', 
        `javelin` = '7', 
        `magic_stick` = '34', 
        `mask_of_madness` = '172', 
        `shadow_amulet` = '215', 
        `null_talisman` = '77', 
        `tome_of_knowledge` = '257', 
        `gloves` = '25', 
        `circlet` = '20', 
        `bracer` = '73', 
        `claymore` = '5', 
        `ultimate_orb` = '24', 
        `recipe_cyclone` = '99', 
        `sobi_mask` = '28', 
        `mjollnir` = '158', 
        `silver_edge` = '249', 
        `dagon_4` = '203', 
        `belt_of_strenght` = '17', 
        `lesser_crit` = '149', 
        `staff_of_wizardry` = '23', 
        `eagle` = '52', 
        `boots_of_elves` = '18', 
        `ghost` = '37', 
        `vanguard` = '125', 
        `tranquil_boots` = '214', 
        `ancient_janggo` = '185',  
        `recipe_mjollnir` = '157', 
        `slippers` = '14', 
        `skadi` = '160', 
        `greater_crit` = '141', 
        `octarine_core` = '235', 
        `ward_observer` = '42', 
        `ring_of_basilius` = '88', 
        `rapier` = '133', 
        `flask` = '39', 
        `medallion_of_courage` = '187', 
        `desolator` = '168', 
        `vladmir` = '81', 
        `ward_sentry` = '43', 
        `aeether_lens` = '232', 
        `monkey_king_bar` = '135', 
        `butterfly` = '139', 
        `dagon_5` = '204', 
        `blades_of_attack` = '2', 
        `smoke_of_deceit` = '188', 
        `soul_booster` = '129', 
        `recipe_radiance` = '136', 
        `assault` = '112', 
        `ward_dispenser` = '218', 
        `dagon` = '104', 
        `bottle` = '41', 
        `recipe_maelstrom` = '165', 
        `manta` = '147', 
        `moon_shard` = '247', 
        `orchid` = '98', 
        `ethereal_blade` = '176', 
        `dragon_lance` = '236', 
        `point_booster` = '60'
      )), selectize = FALSE),
    
    selectInput('item_5','item_5', choices = list (
      item_5 = c(	
        `sange_and_yasha` = '154', 
        `stout_shield` = '182', 
        `empty` = '0',
        `poor_mans_shield` = '71', 
        `faerie_fire` = '237',
        `tpscroll` = '46', 
        `branches` = '16', 
        `phase_boots` = '50', 
        `maelstrom` = '166', 
        `blades_of_attack` = '2', 
        `oblivion_staff` = '67', 
        `ring_of_aquila` = '212', 
        `quarterstaff` = '10', 
        `power_treads` = '63',
        `iron_talon` = '239', 
        `dust` = '40', 
        `ring_of_regen` = '27', 
        `ring_of_health` = '56', 
        `quelling_blade` = '11', 
        `octarine_core` = '235', 
        `pers` = '69', 
        `ultimate_scepter` = '108', 
        `black_king_bar` = '116', 
        `radiance` = '137', 
        `ogre_axe` = '21', 
        `chainmail` = '4', 
        `blade_mail` = '127', 
        `mask_of_madness` = '172', 
        `void_stone` = '57', 
        `cyclone` = '100', 
        `ward_observer` = '42', 
        `echo_sabre` = '252', 
        `wind_lace` = '244', 
        `boots_of_elves` = '18', 
        `boots` = '29', 
        `flask` = '39', 
        `hyperstone` = '55', 
        `talisman_of_evasion` = '32', 
        `blink` = '1', 
        `belt_of_strength` = '17', 
        `gloves` = '25', 
        `clarity` = '38', 
        `arcane_boots` = '180', 
        `necronomicon_3` = '194', 
        `butterfly` = '139', 
        `relic` = '54', 
        `silver_edge` = '249', 
        `magic_wand` = '36', 
        `tango` = '44',
        `hand_of_midas` = '65', 
        `circlet` = '20', 
        `heart` = '114', 
        `infused_raindrop` = '265', 
        `blight_stone` = '240', 
        `mithril_hammer` = '8', 
        `broadsword` = '3', 
        `enchanted_mango` = '216', 
        `desolator` = '168', 
        `invis_sword` = '152', 
        `ring_of_protection` = '12', 
        `tome_of_knowledge` = '257', 
        `basher` = '143', 
        `vitality_booster` = '61', 
        `blade_of_alacrity` = '22', 
        `orb_of_venom` = '181', 
        `monkey_king_bar` = '135', 
        `yasha` = '170', 
        `platemail` = '9', 
        `tango_single` = '241', 
        `travel_boots` = '48', 
        `reaver` = '53', 
        `ultimate_orb` = '24', 
        `force_staff` = '102', 
        `magic_stick` = '34', 
        `lifesteal` = '26', 
        `heavens_halberd` = '210', 
        `cloak` = '31', 
        `recipe_radiance` = '136', 
        `vladmir` = '81', 
        `wraith_band` = '75', 
        `slippers` = '14', 
        `rapier` = '133', 
        `dagon_2` = '201', 
        `sange` = '162', 
        `bfury` = '145', 
        `point_booster` = '60', 
        `robe` = '19', 
        `shadow_amulet` = '215', 
        `ghost` = '37', 
        `helm_of_iron_will` = '6', 
        `demon_edge` = '51', 
        `dagon` = '104', 
        `ward_sentry` = '43', 
        `claymore` = '5', 
        `aegis` = '117', 
        `eagle` = '52', 
        `javelin` = '7', 
        `staff_of_wizardry` = '23', 
        `soul_booster` = '129', 
        `ring_of_basilius` = '88', 
        `vanguard` = '125', 
        `bottle` = '41', 
        `sphere` = '123', 
        `ancient_janggo` = '185', 
        `null_talisman` = '77', 
        `lesser_crit` = '149', 
        `moon_shard` = '247', 
        `greater_crit` = '141', 
        `recipe_sange` = '161', 
        `smoke_of_deceit` = '188', 
        `assault` = '112', 
        `recipe_black_king_bar` = '115', 
        `sobi_mask` = '28', 
        `dagon_5` = '204', 
        `diffusal_blade` = '174', 
        `mjollnir` = '158', 
        `manta` = '147'
      )), selectize = FALSE),
    submitButton("Enviar")
  ),
  mainPanel(
    verbatimTextOutput('values'),
    tableOutput("table"),
    #tableOutput("tablex"),
    # verbatimTextOutput('pred')
    #plotOutput("plotTree"),
    plotOutput("plotTreeCV"),
    verbatimTextOutput('selected')
    # plotOutput("plotNeural")
  )
), title = 'Selecionar Hero')
server <- function(input, output, session) {
  
  output$values <- renderPrint({
    list( hero_id = input$hero_id)
  })
  output$table <- renderTable({
    setwd('C:\\data\\out')
    tab <- read.csv(paste(paste("teste_hero", input$hero_id, sep=""), ".csv", sep=""))
    head(tab)
  })
  output$plotTreeCV <- renderPlot( {
    getTreeCV(input$hero_id)
  })
  output$selected <- renderPrint({
    list(getTreeFromInput(input))
  })
  
  output$tablex <- renderTable ({
    setwd('C:\\data\\out')
    set <- read.csv(paste(paste("teste_hero", input$hero_id, sep=""), ".csv", sep=""))
    library(caTools)
    spl <- sample.split(set$player.win, SplitRatio = 0.7)
    Train <- subset(set, spl==TRUE)
    Test <- subset(set, spl==FALSE)
    
    log <-glm(player.win ~ player.assists + 
                player.denies + 
                player.deaths + 
                player.kills + 
                player.level + 
                player.benchmarks.gold_per_min.raw + 
                player.tower_damage + 
                player.hero_damage,
              data = Train,
              family = binomial)
    pred <- predict(log, type="response", newdata = Test)
    t <- NA
    t <- table (round(pred), Test$player.win)
    ac <- (t[1,1] + t[2,2])/((t[1,1] + t[2,2]) + t[1,2] + t[2,1]) * 100
    
    table (round(pred), Test$player.win)
    
   
    
  })
  
  
}
# Create Shiny app ----
shinyApp(ui, server)
#rsconnect::deployApp(appDir = "E:\\Rapp", appFiles = "app.R",account = 'pehls',upload = TRUE)

#https://pt.dotabuff.com/heroes/economy ----
#comparar dados com resultados de média do site,
#dividir resultados do site em quartis, acima do 4, outlier
#entre 1 e 0, outlier
#entre 1 e 4 (caso desvio padrão não muito alto), pertence ao cj
# Qi = (i(n+1))/4

#carries
#Drow ranger 6 +++++++
#Bloodseeker 4 ++++++++++
#Anti-Mage 1++++++++++++
#supports
#Lina 25 ++++++++++
#Silencer 75++++++++++++
#Lich 31 ++++++++++++
#Phoenix 110++++++++++++++++
#Shadow Shaman 27+++++++
#Bane 3 +++++++++++
#Tanker
#Lifestealer 54++++++++++++
#Axe 2++++++++++++++
#Sven 18++++++++++++++
#Huskar 59+++++++++++++++++
#Pudge 14++++++++++++
#Wraith King 42+++++++++++
hero_id = c(`Anti-Mage` = '1',
            `Axe` = '2', 
            `Bane` = '3', 
            `Bloodseeker` = '4',
            `Drow Ranger` = '6',
            `Lina` = '25',
            `Silencer` = '75',
            `Lich` = '31',
            `Phoenix` = '110',
            `Shadow Shaman` = '27',
            `Lifestealer` = '54',
            `Sven` = '18',
            `Huskar` = '59',
            `Pudge` = '14',
            `Wraith King` = '42'
            )

#---------------------------data cleaning-------------
t14[which(t14$player.assists==0),] <- NA
t14 <- t14[complete.cases(t14),]
#sups
mean( 
   summary(t25$player.benchmarks.hero_damage_per_min.raw)[2],
   summary(t75$player.benchmarks.hero_damage_per_min.raw)[2],
   summary(t31$player.benchmarks.hero_damage_per_min.raw)[2],
  summary(t110$player.benchmarks.hero_damage_per_min.raw)[2],
   summary(t27$player.benchmarks.hero_damage_per_min.raw)[2],
    summary(t3$player.benchmarks.hero_damage_per_min.raw)[2])
#carr
mean( 
  summary(t6$player.assists)[6],
  summary(t4$player.assists)[6],
  summary(t1$player.assists)[6])
#tanks
mean( 
  summary(t14$player.benchmarks.hero_damage_per_min.raw)[5],
  summary(t54$player.benchmarks.hero_damage_per_min.raw)[5],
  summary(t42$player.benchmarks.hero_damage_per_min.raw)[5],
   summary(t2$player.benchmarks.hero_damage_per_min.raw)[5],
  summary(t18$player.benchmarks.hero_damage_per_min.raw)[5],
  summary(t59$player.benchmarks.hero_damage_per_min.raw)[5])

getByIDSFromURI(getMatchIDSfromJSON(42),42) 
hero_id = c(`Anti-Mage` = '1',#
            `Axe` = '2', #
            `Bane` = '3', #
            `Bloodseeker` = '4',#
            `Drow Ranger` = '6',
            `Lina` = '25',
            `Silencer` = '75',
            `Lich` = '31',
            `Phoenix` = '110',
            `Shadow Shaman` = '27',
            `Lifestealer` = '54',
            `Sven` = '18',
            `Huskar` = '59',
            `Pudge` = '14',
            `Wraith King` = '42'
)

getMatchIDSfromJSON <- function( hero_id) {
  wd <-"C:\\data\\byHero"
  nFiles <- length(getFilesFromWD(paste(paste(wd,"\\00-",sep=""), hero_id, sep=""))) -1
  list <- list()
  temp <- list()
  library(jsonlite)
  setwd(paste(paste(wd,"\\00-",sep=""), hero_id, sep=""))
  for(j in 20:30) {
    tryCatch({
      name <- paste(paste(paste(j ,"-", sep=""),hero_id,sep=""),".json", sep="")
      data <- fromJSON(name, flatten=TRUE)
      temp$match_id <- data$result$matches$match_id
      list <- rbind(list, as.data.frame(temp))
      
    },error = function(cond) {
      return (NA)
    }, warning = function(cond) {
      return (NULL)
    })
  }
  
  return (list)
}
# getTree(i)
# getTreeCV(i)
 normalize(4)

#testes metodos ----
setwd('C:\\data\\out')
set = read.csv('teste_hero2.csv')
library(caTools)
spl <- sample.split(set$player.win, SplitRatio = 0.7)
Train <- subset(set, spl==TRUE)
Test <- subset(set, spl==FALSE)
#rede neural ----
library(neuralnet)
net <- neuralnet(player.win ~ player.assists + 
                              player.denies + 
                              player.deaths + 
                              player.kills + 
                              player.level + 
                              player.benchmarks.gold_per_min.raw + 
                              player.tower_damage + 
                              player.hero_damage,
                              data = normalizedTrain,
                              hidden = 8,
                              threshold = 0.01,
                              linear.output = FALSE,
                              act.fct = 'logistic')
plot(net)
net.pred <- compute(net, normalizedTrain[,
                                         c("player.assists",
                                           "player.denies",
                                           "player.deaths",
                                           "player.kills",
                                           "player.level", 
                                           "player.benchmarks.gold_per_min.raw",
                                           "player.tower_damage",
                                           "player.hero_damage")])
results <- data.frame(actual <- normalizedTrain$player.win, predict <- net.pred$net.result)
results
roundedResults <- sapply(results, round, digits=0)
roundedResults <- as.data.frame(roundedResults)
table(roundedResults)
mse <- sum((normalizedTrain$player.win - net.pred$net.result)^2/nrow(normalizedTrain))


train <- train(player.win~player.item_0+player.item_1+player.item_2+player.item_3+player.item_4+player.item_5, 
               data=Train,
               method="rpart",
               trControl=numfolds,
               tuneGrid=cpgrid)
#neuralnet usando itens----
setwd('C:\\data\\out')
set = read.csv('teste_hero2.csv')
library(caTools)
spl <- sample.split(set$player.win, SplitRatio = 0.7)
Train <- subset(set, spl==TRUE)
Test <- subset(set, spl==FALSE)
library(neuralnet)
net <- neuralnet(player.win~
                   player.item_0+
                   player.item_1+
                   player.item_2+
                   player.item_3+
                   player.item_4+
                   player.item_5, 
                 data = set,
                 hidden = 4,
                 threshold = 0.01,
                 linear.output = FALSE,
                 act.fct = 'logistic')
plot(net)
net.pred <- compute(net, set[,
                                         c("player.item_0",
                                           "player.item_1",
                                           "player.item_2",
                                           "player.item_3",
                                           "player.item_4", 
                                           "player.item_5")])
results <- data.frame(actual <- set$player.win, predict <- net.pred$net.result)
results
roundedResults <- sapply(results, round, digits=0)
roundedResults <- as.data.frame(roundedResults)
table(roundedResults)
mse <- sum((normalizedTrain$player.win - net.pred$net.result)^2/nrow(normalizedTrain))

#regressão logistica ----
log <-glm(player.win ~ player.item_0 + 
            player.item_1 + 
            player.item_2 + 
            player.item_3 + 
            player.item_4 + 
            player.item_5,
          data = Train,
          family = binomial)
pred <- predict(log, type="response", newdata = Test)
t <- table (round(pred), Test$player.win)
t
#testes normalização ----
normalize <- function (hero_id) {
  setwd('C:\\data\\out')
  data <- read.csv(paste(paste( 'teste_hero',hero_id, sep=""), '.csv', sep=""))
  t<- list()
  normalized <- list()
  t$player.win <- data$player.win
  t$player.assists <- data$player.assists
  t$player.denies <- data$player.denies
  t$player.deaths <- data$player.deaths
  t$player.kills <- data$player.kills
  t$player.level <- data$player.level
  t$player.hero_healing <- data$player.hero_healing
  t$player.benchmarks.gold_per_min.raw  <- data$player.benchmarks.gold_per_min.raw
  t$player.tower_damage <- data$player.tower_damage
  t$player.hero_damage <- data$player.hero_damage
  ranges <- list()
  ranges <- sapply(t, function(x) {return ((x - min(x)) / (max(x) - min (x)) )})
  normalized <- sapply(t, function(x) {return ((x - min(x)) / (max(x) - min (x)) )})
  setwd('C:\\data\\out')
  write.csv(normalized, file=paste(paste("normalizedTrain_hero",hero_id, sep=""), ".csv", sep=""))
  write.csv(ranges, file=paste(paste("ranges_hero",hero_id, sep=""), ".csv", sep=""))
  
}
